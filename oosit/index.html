<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oosit Etiketleme (KullanÄ±cÄ± Destekli)</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; margin: 0; padding: 20px; }
  .container { max-width: 900px; margin: auto; }
  img { max-width: 100%; max-height: 70vh; border: 2px solid #ccc; border-radius: 10px; margin: 20px 0; }
  button { font-size: 18px; margin: 10px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; }
  .a { background: #007bff; } .a:hover { background: #0056b3; }
  .b { background: #28a745; } .b:hover { background: #1e7e34; }
  .c { background: #ffc107; color: black; } .c:hover { background: #d39e00; color: black; }
  .d { background: #fd7e14; } .d:hover { background: #e8590c; }
  .e { background: #dc3545; } .e:hover { background: #bd2130; }
  #download { background: #17a2b8; } #download:hover { background: #117a8b; }
  #reset { background: #6c757d; } #reset:hover { background: #5a6268; }
  #userBox { margin-top: 30px; }
  input { padding: 8px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
</style>
</head>
<body>
<div class="container">
  <h2> Oosit Etiketleme AracÄ±</h2>
  <p>FotoÄŸraflarÄ± sÄ±rasÄ±yla etiketleyin. KaldÄ±ÄŸÄ±nÄ±z yer otomatik kaydedilir.</p>

  <div id="userBox">
    <input id="username" placeholder="KullanÄ±cÄ± adÄ± veya numara" />
    <button onclick="saveUser()">Kaydet</button>
  </div>

  <div id="mainUI" style="display:none;">
    <p><strong>KullanÄ±cÄ±:</strong> <span id="activeUser"></span></p>
    <img id="photo" src="" alt="FotoÄŸraf yÃ¼kleniyor...">
    
    <div>
      <button class="a" onclick="label('A')">A</button>
      <button class="b" onclick="label('B')">B</button>
      <button class="c" onclick="label('C')">C</button>
      <button class="d" onclick="label('D')">D</button>
      <button class="e" onclick="label('Ã‡Ã–P')">E</button>
    </div>

    <p id="progress"></p>

    <div>
      <button id="download" onclick="downloadCSV()">ğŸ“¥ CSV Ä°ndir</button>
      <button id="reset" onclick="resetProgress()">â™»ï¸ SÄ±fÄ±rla</button>
    </div>
  </div>
</div>

<script type="module">
// --- Firebase SDK ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ğŸ”§ Firebase yapÄ±landÄ±rma (kendi bilgilerini gir)
const firebaseConfig = {
  apiKey: "AIzaSyD1HInxSy7xI9xWywvMsobeFu0qGVW5wJw",
  authDomain: "oosit-d5190.firebaseapp.com",
  projectId: "oosit-d5190",
  storageBucket: "oosit-d5190.firebasestorage.app",
  messagingSenderId: "333999398179",
  appId: "1:333999398179:web:75da8319fb10e678310096",
  measurementId: "G-GLVGFDJ56B"
};

// --- Firebase baÅŸlat ---
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Global deÄŸiÅŸkenler ---
let images = [];
let current = 0;
let results = JSON.parse(localStorage.getItem("etiketler") || "[]");
let lastIndex = parseInt(localStorage.getItem("index") || "0");
let user = localStorage.getItem("user") || "";

// --- KullanÄ±cÄ± adÄ± kaydet ---
window.saveUser = function () {
  const val = document.getElementById("username").value.trim();
  if (!val) {
    alert("LÃ¼tfen bir kullanÄ±cÄ± adÄ± veya numara girin!");
    return;
  }
  user = val;
  localStorage.setItem("user", user);
  initUI();
};

// --- ArayÃ¼zÃ¼ baÅŸlat ---
function initUI() {
  document.getElementById("userBox").style.display = "none";
  document.getElementById("mainUI").style.display = "block";
  document.getElementById("activeUser").innerText = user;
  loadImages();
}

// --- JSONâ€™dan fotoÄŸraf listesi yÃ¼kle ---
async function loadImages() {
  try {
    const response = await fetch("https://smttl.github.io/oosit/dosyalar.json");
    images = await response.json();
    console.log(`ğŸ“¸ ${images.length} fotoÄŸraf yÃ¼klendi.`);
  } catch (err) {
    console.error("âŒ JSON yÃ¼klenemedi:", err);
    alert("FotoÄŸraf listesi yÃ¼klenemedi!");
    return;
  }

  current = lastIndex < images.length ? lastIndex : 0;
  showImage();
}

// --- GÃ¶rsel gÃ¶ster ---
function showImage() {
  const imgElem = document.getElementById("photo");
  const progElem = document.getElementById("progress");

  if (current >= images.length) {
    imgElem.src = "";
    progElem.innerText = "âœ… TÃ¼m fotoÄŸraflar etiketlendi!";
    return;
  }

  const imgURL = `https://smttl.github.io/oosit/images/${images[current]}`;
  imgElem.src = imgURL;
  progElem.innerText = `FotoÄŸraf ${current + 1} / ${images.length}`;
}

// --- Etiketleme iÅŸlemi ---
window.label = async function (etiket) {
  if (!user) {
    alert("LÃ¼tfen kullanÄ±cÄ± adÄ±nÄ±zÄ± girin!");
    return;
  }

  const file = images[current];
  const record = { 
    dosya_adi: file, 
    etiket, 
    timestamp: new Date().toISOString(),
    kullanici: user 
  };

  try {
    await addDoc(collection(db, "etiketler"), record);
    console.log(`âœ… ${file} -> ${etiket} (${user}) Firestoreâ€™a kaydedildi`);
  } catch (e) {
    console.error("âŒ Firestore hatasÄ±:", e);
  }

  results.push(record);
  localStorage.setItem("etiketler", JSON.stringify(results));
  localStorage.setItem("index", current + 1);

  current++;
  showImage();
};

// --- CSV indir ---
window.downloadCSV = function () {
  let csv = "dosya_adi,etiket,timestamp,kullanici\n";
  results.forEach(r => csv += `${r.dosya_adi},${r.etiket},${r.timestamp},${r.kullanici}\n`);
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "etiketler.csv";
  a.click();
  URL.revokeObjectURL(url);
};

// --- Resetle ---
window.resetProgress = function () {
  if (confirm("TÃ¼m ilerlemeyi ve kullanÄ±cÄ± adÄ±nÄ± sÄ±fÄ±rlamak istiyor musun?\n(Bu iÅŸlem Firestore kayÄ±tlarÄ±nÄ± silmez)")) {
    localStorage.clear();
    results = [];
    current = 0;
    user = "";
    location.reload();
  }
};

// --- BaÅŸlat ---
if (user) {
  initUI();
}
</script>
</body>
</html>
